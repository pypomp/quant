---
title: "Measles Report"
format:
  html:
    toc: true
    embed-resources: true
engine: knitr
---

```{r Load R libraries, echo = FALSE}
library(reticulate)
library(tidyverse)
library(pomp)
setwd(paste0(here::here(), "/measles"))
sessionInfo()

knitr::opts_chunk$set(echo = FALSE)
```

```{r}
print(Sys.time())
```

```{python Import python modules}
import os
import pickle
import numpy as np
import pandas as pd
import pypomp as pp
import jax
import matplotlib.pyplot as plt
```

```{python Load data in python}
PKL_PATH = "gpu/measles_results.pkl"
pomp_obj = pickle.load(open(PKL_PATH, "rb"))
```

```{python Make basic frame}
LL_frame = pomp_obj.results()
traces = pomp_obj.traces()
```



# Python results

## Tables

```{r Make traces frame in R}
traces <- py$traces
best_rep <- py$LL_frame$index[[1]]
traces <- traces |>
    rename(rep = replicate, iter = iteration) |>
    pivot_longer(
        cols = c(-rep, -iter, -logLik, -method),
        names_to = "quantity",
        values_to = "param_value"
    )
```


### Summary
```{python}
pomp_obj.print_summary()
print(pomp_obj.results(ignore_nan=True).sort_values(by="logLik", ascending=False))
```

### Top results for each method call
```{python}
for i in range(len(pomp_obj.results_history)):
    print(pomp_obj.results(index=i).sort_values(by="logLik", ascending=False).head())
```

## Plot traces

```{r Set best_rep}
# Set best_rep to the rep with the largest logLik on the last iteration
last_iter <- max(traces$iter)
best_rep <- traces |>
    filter(iter == last_iter, method == "pfilter") |>
    group_by(rep) |>
    summarise(final_logLik = logLik[1]) |>
    arrange(desc(final_logLik)) |>
    slice(1) |>
    pull(rep)
```

```{r Plot traces, fig.width = 10, fig.height = 10}
ggplot(
    traces,
    aes(x = iter, y = param_value, group = rep, color = as.factor(rep))
) +
    geom_line(show.legend = FALSE) +
    facet_wrap(vars(quantity), scales = "free")
```

```{r Plot traces (natural scale), fig.width = 10, fig.height = 10}
traces_pertubation_scale <- traces |>
    mutate(
        param_value = case_when(
            quantity == "logLik" ~ param_value,
            quantity == "R0" ~ log(param_value),
            quantity == "sigma" ~ log(param_value),
            quantity == "gamma" ~ log(param_value),
            quantity == "iota" ~ log(param_value),
            quantity == "rho" ~ logit(param_value),
            quantity == "sigmaSE" ~ log(param_value),
            quantity == "psi" ~ log(param_value),
            quantity == "cohort" ~ logit(param_value),
            quantity == "amplitude" ~ logit(param_value),
            quantity == "S_0" ~ log(param_value),
            quantity == "E_0" ~ log(param_value),
            quantity == "I_0" ~ log(param_value),
            quantity == "R_0" ~ log(param_value),
            TRUE ~ param_value
        )
    )

ggplot(
    traces_pertubation_scale,
    aes(x = iter, y = param_value, group = rep, color = as.factor(rep))
) +
    geom_line(show.legend = FALSE) +
    facet_wrap(vars(quantity), scales = "free")
```


```{r Final parameter values}
traces |>
    filter(method == "pfilter") |>
    ggplot(aes(y = param_value, x = quantity)) +
    geom_violin() +
    facet_wrap(vars(quantity), scales = "free")
```


```{r Plot LL traces, eval = TRUE}
ggplot(
    traces,
    aes(x = iter, y = logLik, group = rep, color = as.factor(rep))
) +
    geom_line(show.legend = FALSE)
```


### CLL plots

```{python}


# Extract the CLL array: shape (replicates, time index)
CLL_array = pomp_obj.results_history[-1].CLL[0]

# Compute statistics across replicates for each time index
mean_CLL = np.mean(CLL_array, axis=0)
q10 = np.percentile(CLL_array, 10, axis=0)
q90 = np.percentile(CLL_array, 90, axis=0)
time_idx = np.arange(CLL_array.shape[1])

plt.figure(figsize=(10, 5))
plt.plot(time_idx, mean_CLL, label="Mean CLL", color="C0")
plt.fill_between(time_idx, q10, q90, color="C0", alpha=0.5, label="10%-90% quantile")
plt.xlabel("Time Index")
plt.ylabel("Conditional Log Likelihood")
plt.title("Conditional Log Likelihoods (Mean and 10%-90% Quantiles)")
plt.legend()
plt.tight_layout()
plt.show()

# Second plot: Show individual replicate CLLs
plt.figure(figsize=(10, 5))
colors = plt.cm.tab20(np.linspace(0, 1, CLL_array.shape[0]))
for i in range(CLL_array.shape[0]):
    plt.plot(time_idx, CLL_array[i], color=colors[i], alpha=0.7)
plt.xlabel("Time Index")
plt.ylabel("Conditional Log Likelihood (individual reps)")
plt.title("Conditional Log Likelihoods for All Replicates")
plt.tight_layout()
plt.show()
```